# -*- coding: utf-8 -*-
import socket
import threading
import sys
import os

def socket_service():#监听白板车通告
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind(('127.0.0.1', 8888))
        s.listen(10)
    except socket.error as msg:
        print (msg)
        sys.exit(1)
    print ('waiting for new car...')

    while 1:
        (conn,addr) = s.accept()
        t = threading.Thread(target=vote_and_create, args=(conn, addr))
        t.start()

def deal_result(result):#可能需要从链码返回中提取返回值,作为该函数的返回
    pass
    return vres

def make_new_id():#调用sdk生成一个新的身份文件
    pass
    return sth

def vote_and_create(conn, addr):#已经认证的车辆收到来自白板车的通告后开始投票,等待链码返回并继续
    print('Accept new request from' + format(addr))
    vote_result = os.system(invoke)#调用链码并等待返回
    if deal_result(vote_result) == 1:#返回为1时，被选为身份发放代理，制作新身份
        print('You are the Agent , Creating a new id...')
        newid = make_new_id()
        print('Sending new id to car')
        conn.send(newid)
        print('Sending Completed')
        conn.close()
        pass
    else:#返回不为1时，关闭该线程，开启监听，等待下一次申请
        print('You are not the Agent')
        conn.close()
        pass

if __name__ == '__main__':
    socket_service()
